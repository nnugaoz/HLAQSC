
@{
    Layout = null;
}

<!DOCTYPE html>

<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title></title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link href="../../Contents/MyUI/css/content.css" rel="stylesheet" />

    <link href="../../Contents/bootstrap-3.3.7/css/bootstrap.min.css" rel="stylesheet" />
    <script src="../../Contents/Scripts/jquery-1.11.3.min.js"></script>
    <script src="../../Contents/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script src="../../Contents/layer/layer.js"></script>
    <script src="../../Contents/My97DatePicker/WdatePicker.js"></script>

    <script src="../../Scripts_Common/Common.js"></script>
    <script src="../../Scripts_Common/ParaData.js"></script>

    <script src="../../Scripts_Common/PageList.js"></script>
</head>
<body style="overflow-x:hidden;overflow-y:hidden;">
    <input type="hidden" id="ID" value="" />
    <div style="margin:10px;">
        <div>
            <div class="form-group" style="height:480px;width:420px;float:left;">
                <div class="input-group">
                    <div class="input-group-addon" style="width: 100px; text-align: right; color: red;">工作时间：</div>
                    <input id="WorkDate" type="text" readonly="readonly" placeholder="工作时间" class="form-control" style="background: #fff url('../../Contents/My97DatePicker/skin/datePicker.gif')no-repeat right; cursor: default; width:300px;" onclick="WdatePicker({ dateFmt: 'yyyy-MM-dd' })" />
                </div>
                <div style="height:10px;">&nbsp;</div>
                <div class="input-group">
                    <div class="input-group-addon" style="width: 100px; text-align: right;">班次：</div>
                    <select class="form-control" id="WorkClassCode" style="width:300px;"></select>
                    <input type="hidden" id="WorkClassName" value="" />
                </div>
                <div style="height:10px;">&nbsp;</div>
                <div class="input-group">
                    <div class="input-group-addon" style="width: 100px; text-align: right;">录入人：</div>
                    <input type="text" style="width:300px;" class="form-control" id="WorkManName" readonly value="@ViewBag.UserName">
                    <input type="hidden" id="WorkManID" value="@ViewBag.UserID" />
                    <input type="hidden" id="RRoleCode" value="@ViewBag.RRoleCode" />
                </div>
                <div style="height:10px;">&nbsp;</div>
                <div class="input-group">
                    <div class="input-group-addon" style="width: 100px; text-align: right;">工作时长：</div>
                    <input type="text" style="width:230px;" class="form-control" id="WorkHour" readonly value="0.0">
                    <div class="input-group-addon" style="width: 70px;">小时</div>
                </div>
                <div style="height:10px;">&nbsp;</div>
                <button type="button" class="input-group-addon btn btn-primary" style="width:100px;height:34px;border-left:1px solid #C0C0C0;" onclick="Btn_Save();">全部提交</button>
            </div>
            <div class="form-group" style="height:480px;width:760px;float:left;">
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#div1" aria-controls="div1" name="div1" role="tab" data-toggle="tab">第一项</a></li>
                    <li role="presentation"><a href="#div2" aria-controls="div2" name="div2" role="tab" data-toggle="tab">第二项(禁用)</a></li>
                    <li role="presentation"><a href="#div3" aria-controls="div3" name="div3" role="tab" data-toggle="tab">第三项(禁用)</a></li>
                    <li role="presentation"><a href="#div4" aria-controls="div4" name="div4" role="tab" data-toggle="tab">第四项(禁用)</a></li>
                    <li role="presentation"><a href="#div5" aria-controls="div5" name="div5" role="tab" data-toggle="tab">第五项(禁用)</a></li>
                </ul>
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="div1">
                        <div class="input-group" style="margin-top:10px;">
                            <div class="input-group-addon" style="width: 100px; text-align: right; color: red;">设备：</div>
                            <select class="form-control" name="EquipmentID" style="width:300px;"></select>
                        </div>
                        <div style="height:10px;">&nbsp;</div>
                        <div class="input-group">
                            <div class="input-group-addon" style="width: 100px; text-align: right; color: red;">工作时长：</div>
                            <input type="text" style="width:230px;" class="form-control" name="WorkHour" maxlength="4" value="0.0">
                            <div class="input-group-addon" style="width: 70px;">小时</div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="div2">
                        <div class="input-group" style="margin-top:10px;">
                            <div class="input-group-addon" style="width: 100px; text-align: right; color: red;">设备：</div>
                            <select class="form-control" name="EquipmentID" style="width:300px;" disabled></select>
                            <button type="button" class="input-group-addon btn btn-primary" style="width:100px;height:34px;" onclick="Btn_Disabled(this);">启用/禁用</button>
                        </div>
                        <div style="height:10px;">&nbsp;</div>
                        <div class="input-group">
                            <div class="input-group-addon" style="width: 100px; text-align: right; color: red;">工作时长：</div>
                            <input type="text" style="width:230px;" class="form-control" name="WorkHour" maxlength="4" value="0.0" disabled>
                            <div class="input-group-addon" style="width: 70px;">小时</div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="div3">
                        <div class="input-group" style="margin-top:10px;">
                            <div class="input-group-addon" style="width: 100px; text-align: right; color: red;">设备：</div>
                            <select class="form-control" name="EquipmentID" style="width:300px;" disabled></select>
                            <button type="button" class="input-group-addon btn btn-primary" style="width:100px;height:34px;" onclick="Btn_Disabled(this);">启用/禁用</button>
                        </div>
                        <div style="height:10px;">&nbsp;</div>
                        <div class="input-group">
                            <div class="input-group-addon" style="width: 100px; text-align: right; color: red;">工作时长：</div>
                            <input type="text" style="width:230px;" class="form-control" name="WorkHour" maxlength="4" value="0.0" disabled>
                            <div class="input-group-addon" style="width: 70px;">小时</div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="div4">
                        <div class="input-group" style="margin-top:10px;">
                            <div class="input-group-addon" style="width: 100px; text-align: right; color: red;">设备：</div>
                            <select class="form-control" name="EquipmentID" style="width:300px;" disabled></select>
                            <button type="button" class="input-group-addon btn btn-primary" style="width:100px;height:34px;" onclick="Btn_Disabled(this);">启用/禁用</button>
                        </div>
                        <div style="height:10px;">&nbsp;</div>
                        <div class="input-group">
                            <div class="input-group-addon" style="width: 100px; text-align: right; color: red;">工作时长：</div>
                            <input type="text" style="width:230px;" class="form-control" name="WorkHour" maxlength="4" value="0.0" disabled>
                            <div class="input-group-addon" style="width: 70px;">小时</div>
                        </div>
                    </div>
                    <div role="tabpanel" class="tab-pane" id="div5">
                        <div class="input-group" style="margin-top:10px;">
                            <div class="input-group-addon" style="width: 100px; text-align: right; color: red;">设备：</div>
                            <select class="form-control" name="EquipmentID" style="width:300px;" disabled></select>
                            <button type="button" class="input-group-addon btn btn-primary" style="width:100px;height:34px;" onclick="Btn_Disabled(this);">启用/禁用</button>
                        </div>
                        <div style="height:10px;">&nbsp;</div>
                        <div class="input-group">
                            <div class="input-group-addon" style="width: 100px; text-align: right; color: red;">工作时长：</div>
                            <input type="text" style="width:230px;" class="form-control" name="WorkHour" maxlength="4" value="0.0" disabled>
                            <div class="input-group-addon" style="width: 70px;">小时</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        if ("@ViewBag.HaveRight" == "0") {
            alert("管理员不能填写数据！");
            parent.layer.close(parent.layer.getFrameIndex(window.name));
        }

        var mObj = CommonFun_Data();
        mObj.Fun_Data_Init({ "ID": "", "RecordType": "E", "WorkDate": "", "WorkClassCode": "", "WorkClassName": "", "WorkManID": "", "WorkManName": "", "WorkHour": "0", "RRoleCode": "@ViewBag.RRoleCode", "Status": "1", "Del": "0", "Equipments": "{0}" });

        var dObj = {
            "Data": [],
            "GetOneByID": function (ID) {
                var obj = this.Data;
                if (obj != null && obj.length > 0) {
                    for (var i = 0 ; i < obj.length; i++) {
                        var row = obj[i];
                        if (row.EquipmentID == ID) {
                            return row;
                        }
                    }
                }
                return null;
            }
        };
        var dfObj = {
            "Data": [],
            "GetOneByType": function (Type) {
                var obj = this.Data;
                var ret = [];
                if (obj != null && obj.length > 0) {
                    for (var i = 0 ; i < obj.length; i++) {
                        var row = obj[i];
                        if (row.Type2 == Type) {
                            ret.push(row);
                        }
                    }
                }
                return ret;
            }
        };
        var dfTypeObj = {
            "Data": [],
            "GetSelectByDFKey": function (dfKey) {
                var obj = this.Data;
                var ret = [];
                if (obj != null && obj.length > 0) {
                    for (var i = 0; i < obj.length; i++) {
                        var row = obj[i];
                        if (row.DFKey == dfKey) {
                            ret.push(row);
                        }
                    }
                }
                return ret;
            }
        }

        $(function () {
            $("#WorkDate").val(CommonFun_GetNowFormatDate());

            var data;
            eval("(data = @Html.Raw(ViewBag.Ret));");

            // 初始化班次
            CommonFun_Select_Init("WorkClassCode", data.obj5);

            // 初始化设备
            var obj = data.obj6;
            var html = "<option value=''></option>";
            if (obj != null && obj.length > 0) {
                for (var i = 0 ; i < obj.length; i++) {
                    var row = obj[i];
                    dObj.Data[i] = { "EquipmentID": row.ID, "EquipmentName": row.Title, "EquipmentType": row.Type };
                    html += "<option value='" + row.ID + "'>" + row.Title + "</option>";
                }
            }
            $("select[name='EquipmentID']").each(function () {
                $(this).html(html);
            });

            // 初始化字段
            var obj = data.obj7;
            if (obj != null && obj.length > 0) {
                for (var i = 0 ; i < obj.length; i++) {
                    var row = obj[i];
                    dfObj.Data[i] = { "Type2": row.Type2, "FieldKey": row.FieldKey, "FieldName": row.FieldName, "FieldUnit": row.FieldUnit, "FieldUnitName": row.FieldUnitName, "FieldType": row.FieldType, "FieldMode": row.FieldMode };
                }
            }

            dfTypeObj.Data = data.obj8;

            //下拉框变化时响应
            $("select[name='EquipmentID']").change(function () {
                var divID = $(this).parent().parent().attr("ID");
                // 移除现有的字段
                $("#" + divID + " div[name='DF']").remove();
                var html = "";

                var equiID = $(this).val();
                if (equiID == "") {
                } else {
                    var obj = dObj.GetOneByID(equiID);
                    if (obj != null) {
                        var fields = dfObj.GetOneByType(obj.EquipmentType);
                        if (fields != null && fields.length > 0) {
                            for (var i = 0 ; i < fields.length; i++) {
                                var row = fields[i];
                                html += "<div name='DF' style='height:10px;'>&nbsp;</div>";
                                html += "<div name='DF' class='input-group'>";
                                html += "<div class='input-group-addon' style='width: 150px; text-align: right;'>" + row.FieldName + "：</div>";

                                if (row.FieldMode == "1") { // 数字
                                    var selectObj = dfTypeObj.GetSelectByDFKey(row.FieldKey);
                                    if (selectObj != null && selectObj.length > 0) {
                                        html += "<input type='text' style='width:150px;' class='form-control' name='" + row.FieldKey + "' mode='" + row.FieldMode + "' maxlength='10' value='0'>";
                                        html += "<div class='input-group-addon' style='width: 50px;'>" + row.FieldUnitName + "</div>";
                                        html += "<select class='form-control' name='DFType' style='width: 100px;'>";
                                        for (var k = 0; k < selectObj.length; k++) {
                                            html += "<option value='" + selectObj[k].SelectVal + "'>" + selectObj[k].SelectTitle + "</option>";
                                        }
                                        html += "</select>";
                                    } else {
                                        html += "<input type='text' style='width:300px;' class='form-control' name='" + row.FieldKey + "' mode='" + row.FieldMode + "' maxlength='10' value='0'>";
                                        html += "<div class='input-group-addon' style='width: 50px;'>" + row.FieldUnitName + "</div>";
                                    }
                                }
                                if (row.FieldMode == "2") { // 文本
                                    html += "<input type='text' style='width:300px;' class='form-control' name='" + row.FieldKey + "' maxlength='20'>";
                                }
                                if (row.FieldMode == "3") { // 时间
                                    html += "<input name='" + row.FieldKey + "' type='text' readonly='readonly' placeholder='" + row.FieldName + "' class='form-control' style='background: #fff url(\"../../Contents/My97DatePicker/skin/datePicker.gif\")no-repeat right; cursor: default; width:300px;' onclick='WdatePicker({ dateFmt: \"yyyy-MM-dd\" })' />";
                                }

                                html += "</div>";
                            }
                        }
                    }
                }

                $("#" + divID).append(html);

                // 绑定事件
                $("#" + divID + " input[mode='1']").unbind().change(function () {
                    var v = parseFloat($(this).val());
                    if (isNaN(v)) {
                        v = 0.0;
                    }
                    $(this).val(v.toFixed(1));
                });
            });

            $("div.tab-content input[name='WorkHour']").change(function () {
                Fun_SetWorkHour();
            });
        });

        function Btn_Disabled(obj) {
            var divID = $(obj).parent().parent().attr("ID");
            var titleObj = $("ul.nav-tabs a[name='" + divID + "']");
            if ($("#" + divID + " select").attr("disabled") == "disabled") {
                titleObj.text(titleObj.text().replace("(禁用)", ""));
                $("#" + divID + " select").removeAttr("disabled");
                $("#" + divID + " input").removeAttr("disabled");
            } else {
                titleObj.text(titleObj.text() + "(禁用)");
                $("#" + divID + " select").val("");
                $("#" + divID + " select").attr("disabled", "disabled");
                $("#" + divID + " input").attr("disabled", "disabled");
                // 移除现有的字段
                $("#" + divID + " div[name='DF']").remove();
            }
            $("#" + divID + " input[name='WorkHour']").val("0.0");

            Fun_SetWorkHour();
        }

        function Fun_SetWorkHour() {
            var h = 0;
            $("div.tab-content input[name='WorkHour']").each(function () {
                var dh = parseFloat($(this).val());
                if (isNaN(dh)) {
                    dh = 0.0;
                } else {
                    dh = parseFloat(dh.toFixed(1));
                }
                h += dh;
                $(this).val(dh.toFixed(1));
            });

            $("#WorkHour").val(h.toFixed(1));
        }
    </script>

    <script type="text/javascript">
        function Btn_Save() {
            var date = $("#WorkDate").val();
            if (date > CommonFun_GetNowFormatDate()) {
                alert("工作时间不能超过当前时间！");
                return false;
            }

            $("#WorkClassCode").find("option").each(function () {
                if ($(this).attr("value") == $("#WorkClassCode").val()) {
                    $("#WorkClassName").val($(this).text());
                }
            });

            var equiData = {
                "Data": [],
                "GetJson": function () {
                    // EquipmentID;WorkHour;FieldKey,FieldValue*FieldKey,FieldValue*FieldKey,FieldValue*%
                    var json = "";
                    if (this.Data == null || this.Data.length == 0) {
                        return "";
                    } else {
                        for (var i = 0; i < this.Data.length; i++) {
                            var row = this.Data[i];
                            //json += "EquipmentID=" + row.EquipmentID + ";WorkHour=" + row.WorkHour + ";DFs=";
                            json += "" + row.EquipmentID + ";" + row.WorkHour + ";";

                            if (row.DFs == null && row.DFs.length == 0) {
                                json += "";
                            } else {
                                for (var j = 0; j < row.DFs.length; j++) {
                                    var df = row.DFs[j];

                                    //json += "FieldKey=" + df.FieldKey + ",FieldValue=" + df.FieldValue + ",FieldType=" + FieldType;
                                    json += "" + df.FieldKey + "," + df.FieldValue + "," + df.FieldType + "*";
                                }
                            }

                            if (json != "") {
                                json += "*";
                            }
                        }
                    }
                    return json;
                }
            }

            var ret = "";
            mObj.Fun_Set_OneCheckInfo("WorkDate", "工作时间", "null");
            try {
                mObj.Fun_Get_Html();
                mObj.Fun_Check();

                str = mObj.Fun_Serialize_All();

                var tf = true;
                $("div.tab-content div.tab-pane").each(function () {
                    if (!tf) {
                        return;
                    }

                    var obj_equi = $(this).find("select[name='EquipmentID']");
                    var obj_div = $(obj_equi.parent().parent());
                    var obj_title = $("ul.nav-tabs a[name='" + obj_div.attr("ID") + "']");
                    if (obj_equi.attr("disabled") == "disabled") { // 设备禁用
                    } else { // 设备启用
                        if (obj_equi.val() == "") { // 未选择设备
                            alert("请选择" + $(obj_title).text() + "的设备！");
                            tf = false;
                            return;
                        } else { // 选择了设备
                            var wh = parseFloat($(obj_div).find("input[name='WorkHour']").val());
                            if (wh <= 0) {
                                alert("请输入" + $(obj_title).text() + "的工作时长！");
                                tf = false;
                                return;
                            } else {
                                var dfData = [];
                                obj_div.find("div[name='DF'] input").each(function () {
                                    var val = $(this).val();
                                    if ($(this).attr("mode") == "1") {
                                        val = parseFloat(val);
                                        if (isNaN(val)) {
                                            val = 0;
                                        }
                                    }

                                    dfData.push({ "FieldKey": $(this).attr("name"), "FieldValue": val, "FieldType": obj_div.find("select[name='DFType']").val() });
                                });

                                equiData.Data.push({ "EquipmentID": obj_equi.val(), "WorkHour": wh, "DFs": dfData });
                            }
                        }
                    }
                });
                if (!tf) {
                    return;
                }

                ret = mObj.Fun_Serialize_All();
                ret = ret.replace("Equipments={0}", "Equipments=" + equiData.GetJson());
            } catch (err) {
                alert(err);
                return false;
            }

            layer.load(2);
            var ajaxObj_check = CommonFun_Ajax();
            ajaxObj_check.url = "../api/C03_EquiDataEntry/DoCheckData";
            ajaxObj_check.data = { "para": mObj.Fun_Serialize_All() };
            ajaxObj_check.getData(function (data) {
                if (data.ret_status == ParaData.ret.Succes) {

                    var ajaxObj = CommonFun_Ajax();
                    ajaxObj.url = "../api/C03_EquiDataEntry/DoSave";
                    ajaxObj.data = { "para": ret };
                    ajaxObj.getData(function (data) {
                        layer.closeAll("loading");

                        if (data.ret_status == ParaData.ret.Succes) {
                            parent.layer.close(parent.layer.getFrameIndex(window.name));
                        } else {
                            alert("保存失败！");
                        }
                    }, function () {
                        // Error
                        layer.closeAll("loading");
                    });

                } else {
                    layer.closeAll("loading");
                    alert("保存失败，当前用户该天已存在数据！");
                }
            }, function () {
                // Error
                layer.closeAll("loading");
            });
        }
    </script>
</body>
</html>
